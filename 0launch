#!/usr/bin/env python
import os, sys
from optparse import OptionParser

from zeroinstall.injector import model, download, autopolicy, run, namespaces

parser = OptionParser(usage="usage: %prog [options] interface [args]\n"
			    "       %prog --list [search-term]")
parser.add_option("-c", "--console", help="never use GUI", action='store_false', dest='gui')
parser.add_option("-d", "--download-only", help="fetch but don't run", action='store_true')
parser.add_option("-D", "--dry-run", help="just print actions", action='store_true')
parser.add_option("-g", "--gui", help="show graphical policy editor", action='store_true')
parser.add_option("-l", "--list", help="list all known interfaces", action='store_true')
parser.add_option("-q", "--quiet", help="suppress informational messages", action='store_true')
parser.add_option("-r", "--refresh", help="refresh all used interfaces", action='store_true')
parser.add_option("-v", "--verbose", help="more verbose output", action='store_true')
parser.add_option("-V", "--version", help="display version information", action='store_true')
parser.disable_interspersed_args()

(options, args) = parser.parse_args()

if options.list:
	if len(args) == 0:
		match = None
	elif len(args) == 1:
		match = args[0].lower()
	else:
		parser.print_help()
		sys.exit(1)
	from zeroinstall.injector import reader
	for i in reader.list_all_interfaces():
		if match and match not in i.lower(): continue
		print i
	sys.exit(0)

if options.version:
	import zeroinstall
	print "0launch (zero-install) " + zeroinstall.version
	print "Copyright (C) 2005 Thomas Leonard"
	print "This program comes with ABSOLUTELY NO WARRANTY,"
	print "to the extent permitted by law."
	print "You may redistribute copies of this program"
	print "under the terms of the GNU General Public License."
	print "For more information about these matters, see the file named COPYING."
	sys.exit(0)

if len(args) < 1:
	parser.print_help()
	sys.exit(1)

# Singleton instance used everywhere...
policy = autopolicy.AutoPolicy(args[0],
				quiet = bool(options.quiet),
				verbose = bool(options.verbose),
				download_only = bool(options.download_only),
				dry_run = options.dry_run)

if options.gui is None and os.environ.get('DISPLAY', None):
	if options.refresh:
		options.gui = True
	else:
		options.gui = policy.need_download()
	if options.gui and not options.quiet:
		print "Need to download; switching to GUI mode"

if options.gui:
	policy.set_root(namespaces.injector_gui_uri)
	
	prog_args = args[:]
	if options.download_only:
		options.download_only = False
		prog_args.insert(0, '--download-only')
	if options.refresh:
		options.refresh = False
		prog_args.insert(0, '--refresh')
else:
	prog_args = args[1:]

try:
	policy.download_and_execute(prog_args, refresh = bool(options.refresh))
except model.SafeException, ex:
	print >>sys.stderr, ex
	sys.exit(1)
except autopolicy.NeedDownload, ex:
	print ex
	sys.exit(0)
